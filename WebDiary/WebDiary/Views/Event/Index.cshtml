@using System.Security.Claims;
@model WebDiary.Models.EventViewModel

@{
    ViewData["Title"] = "Event Calendar";
}

@section scripts {
    <script>
        let someCalendar = null;
        let withGroups = false;
        let withoutGroups = false;
        let isDone = false;

        document.addEventListener('DOMContentLoaded', function () {

            //var Draggable = FullCalendar.Draggable;

            // var containerEll = document.getElementById("kt_docs_fullcalendar_events_list");
            // var Draggable = new FullCalendar.Draggable(containerEll, {
            //     itemSelector: ".fc-event",
            //     eventData: function (eventEl) {
            //         return {
            //             title: eventEl.innerText.trim()
            //         }
            //     }
            // });

            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                nowIndicator: true,
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title', // 'addEventButton',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                footerToolbar: {
                    start: 'AllEventsButton MyEventsButton GroupEventsButton ActiveEventsButton',
                    center: '',
                    end: 'prev,next'
                },
                navLinks: true,
                editable: true, //moving events
                selectable: true,
                selectMirror: true,
                forceEventDuration: true,
                droppable: true,
                dayMaxEvents: true,
                weekNumbers: true,
                eventTimeFormat: { // like '14:30'
                    hour: '2-digit',
                    minute: '2-digit',
                    meridiem: true //am pm
                },
                customButtons: {
                    AllEventsButton: {
                        text: 'All events',
                        click: function (info) {
                            //without filters
                            $('.fc_with_group').toggle(true);
                            $('.fc_without_group').toggle(true);
                            $('.fc_is_done').toggle(true);
                        }
                    },
                    MyEventsButton: {
                        text: 'My events',
                        click: function () {
                            //groupId == null
                            if ($('.fc_with_group').css('display') !== 'none') {
                                $('.fc_with_group').toggle(false);
                                withGroups = true;
                            }
                            else {
                                withGroups = false;
                                $('.fc_with_group').toggle(true)
                            }
                            //$('.fc_with_group').slideToggle()
                        }
                    },
                    GroupEventsButton: {
                        text: 'Group events',
                        click: function () {
                            //groupId != null
                            if ($('.fc_without_group').css('display') !== 'none') {
                                $('.fc_without_group').toggle(false)
                            }
                            else {
                                $('.fc_without_group').toggle(true)
                            }
                        }
                    },
                    ActiveEventsButton: {
                        text: 'Active events',
                        click: function () {
                            //without 'isdone'
                            if ($('.fc_is_done').css('display') !== 'none') {
                                $('.fc_is_done').toggle(false)
                            }
                            else {
                                $('.fc_is_done').toggle(true)
                            }
                        }
                    }
                },
                //TODO: function(){} if null, then load message "no events" and 'events: []'. Events function already async
                //https://stackoverflow.com/questions/62618806/error-error-uncaught-in-promise-typeerror-this-products-is-not-iterable-b
                events: '/Event/LoadEvents',
                // {
                //     url: '/Event/LoadEvents',
                //     method: 'GET',
                //     extraParams: {
                //         custom_param1: 'something',
                //         custom_param2: 'somethingelse'
                //     },
                //     success: function(res) {
                //         //debugger;
                //         res.forEach((element) => res.el.style
                //     },
                //     failure: function () {
                //         alert('There was an error while fetching events!'); //error message from controller
                //     }
                // },

                eventClick: function (info) {
                    info.jsEvent.preventDefault(); // don't let the browser navigate

                    var resp = GetEventDetails(info.event.id);
                    if (typeof resp.responseJSON === 'object' || resp.responseJSON instanceof Object) { //мне не нравится вся эта проверка на стороне клиента, и как в js методах работает тоже, надо поправить
                        ShowEventFulledModal(resp.responseJSON);
                    }

                    ShowEventComments(info.event.id);
                    CreateComment(info.event.id);

                    if (info.event.url) { // open in another tab
                        window.open(info.event.url);
                    }
                },
                eventClassNames: function (arg) {
                    let isDone = arg.event.extendedProps.isDone ? "fc_is_done" : "fc_is_not_done";
                    let isGroup = arg.event.extendedProps.groupIdentificator ? "fc_with_group" : "fc_without_group";
                    return [isDone, isGroup];
                },
                dateClick: function (date, allDay, jsEvent, view) {
                    var start_date = moment(date.dateStr).format('YYYY-MM-DDTHH:mm');
                    ShowEventEmptyModal(start_date);
                },

                eventDidMount: function (info) {
                    $(info.el).tooltip({ //bootstrap tooltip
                        title: info.event.extendedProps.description,
                    });
                    var gid = info.event.extendedProps.groupIdentificator
                    if (gid !== null) {
                        $(info.el).css("border-style", "dotted");
                        $(info.el).css("border-color", info.event.backgroundColor);
                        $(info.el).css("border-width", "2px");
                        $(info.el).css("border-radius", "15px 15px 15px 15px"); //"0px 15px 15px 0px"
                    }
                },
                eventWillUnmount: function (info) {
                    $(info.el).tooltip('dispose');
                },
                eventDrop: function (info) {
                    var test = info.event;
                    console.log(info.event);

                    if (!confirm("Are you sure about this change?")) {
                        info.revert();
                    }
                    else {
                        //patch update
                        var eventdto =
                        {
                            id: info.event.id,
                            userId: info.event.extendedProps.userId,
                            groupIdentificator: info.event.extendedProps.groupIdentificator,
                            title: info.event.title,
                            description: info.event.extendedProps.description,
                            start: moment(info.event.start).format('YYYY-MM-DDTHH:mm'),
                            end: moment(info.event.end).format('YYYY-MM-DDTHH:mm'),//info.event.endStr,
                            allDay: info.event.allDay,
                            url: info.event.url,
                            backgroundColor: info.event.backgroundColor,
                            donedAt: info.event.extendedProps.donedAt,
                            donedByEmail: info.event.extendedProps.donedByEmail,
                            donedById: info.event.extendedProps.donedById,
                            isDone: info.event.extendedProps.isDone
                        };
                        $.ajax({
                            url: '/Event/UpdateEvent',
                            data: JSON.stringify(eventdto),
                            type: "POST",
                            contentType: "application/json;charset=utf-8"
                        }).done(function () {
                            alert('Updated');
                        });
                    }
                },
                eventResize: function (info) {
                    var test = info.event;
                    console.log(info.event);

                    if (!confirm("Are you sure about this change?")) {
                        info.revert();
                    }
                    else {
                        var eventdto =
                        {
                            id: info.event.id,
                            userId: info.event.extendedProps.userId,
                            groupIdentificator: info.event.extendedProps.groupIdentificator,
                            title: info.event.title,
                            description: info.event.extendedProps.description,
                            start: moment(info.event.start).format('YYYY-MM-DDTHH:mm'),
                            end: moment(info.event.end).format('YYYY-MM-DDTHH:mm'),
                            allDay: info.event.allDay,
                            url: info.event.url,
                            backgroundColor: info.event.backgroundColor,
                            donedAt: info.event.extendedProps.donedAt,
                            donedByEmail: info.event.extendedProps.donedByEmail,
                            donedById: info.event.extendedProps.donedById,
                            isDone: info.event.extendedProps.isDone
                        };
                        $.ajax({
                            url: '/Event/UpdateEvent',
                            data: JSON.stringify(eventdto),
                            type: "POST",
                            contentType: "application/json;charset=utf-8"
                        }).done(function () {
                            alert('Updated');
                        });
                    }
                }
            });
            calendar.render();
            someCalendar = calendar;
        });

        $('#btnClose').click(function () {
            $('#schedule').modal('hide');
        });

        //onclick does not honor html5 validation
        $("#btnSave").click(function (event) {
            if ($("#Title")[0].checkValidity() && $("#Start")[0].checkValidity() &&
                $("#End")[0].checkValidity() && $("#Description")[0].checkValidity() &&
                $("#BackgroundColor")[0].checkValidity() && $("#Url")[0].checkValidity()) {
                Add(event);
            }
            else {
                return 0;
            }
        });

        $("#btnEdit").click(function (event) {
            if ($("#Title")[0].checkValidity() && $("#Start")[0].checkValidity() &&
                $("#End")[0].checkValidity() && $("#Description")[0].checkValidity() &&
                $("#BackgroundColor")[0].checkValidity() && $("#Url")[0].checkValidity()) {
                Update(event);
            }
            else {
                return 0;
            }
        });

        function ClearEventModal() {
            $('#Title').val("");
            $('#Description').val("");
            $('#Start').val("");
            $('#End').val("");
            $('#Url').val("");
            document.getElementById("DoneUser").innerHTML = "";
            document.getElementById("DoneTime").innerHTML = "";
            document.getElementById("DoneUserBy").innerHTML = "";
            document.getElementById("DoneTimeAt").innerHTML = "";
            $('#AllDay').prop('checked', false);
            $('#Completed').prop('checked', false);
            $('input:radio[name=BackgroundColor]').each(function () { $(this).prop('checked', false); });
            $('#schedule').children('.modal-dialog').children('.modal-content').find('.Group').val("null");
        }

        function ShowEventEmptyModal(sendDate) {
            ClearEventModal();
            $('#Start').val(sendDate);
            $('#End').val(sendDate);
            $('#schedule :input').prop('disabled', false);
            //$('#btnClose').prop('disabled', false);
            $('#schedule').modal('show');
            $("#show-event-comments-partial").html("");
            $("#create-comment-section-partial").html("");
            $('#btnSave').show();
            $('#btnEdit').hide();
            $('#btnDelete').hide();
            $('#Completed').hide();
            $('#completed').hide();
            $('#Title').focus();
        }

        function ShowEventFulledModal(res) {
            ClearEventModal();
            var groupVal = $('#schedule').children('.modal-dialog').children('.modal-content').find('.Group');
            console.log(groupVal);
            $('#Id').val(res.id);
            $('#Title').val(res.title);
            if (res.isDone !== false) {
                var donetime = moment(res.donedAt).format('HH:mm YYYY-MM-DD');
                document.getElementById("DoneUserBy").innerHTML = "by ";
                document.getElementById("DoneTimeAt").innerHTML = "at ";
                document.getElementById("DoneUser").innerHTML = res.donedByEmail;
                document.getElementById("DoneTime").innerHTML = donetime;
            }
            if (res.groupIdentificator == null) {
                groupVal.val("null");
            } else {
                groupVal.val(res.groupIdentificator);
            }
            $('#DoneId').val(res.donedById);
            $('#UserId').val(res.userId);
            $('#Description').val(res.description);
            $('#Start').val(res.start);
            $('#End').val(res.end);
            $('#Url').val(res.url);
            $('#AllDay').prop('checked', res.allDay);
            $('#Completed').prop('checked', res.isDone);
            $('input:radio[name=BackgroundColor]').each(function () {
                if ($(this).val() == res.backgroundColor) {
                    $(this).prop('checked', true);
                } else {
                    $(this).prop('checked', false);
                }
            });
            if (res.userId != '@User.FindFirstValue(ClaimTypes.NameIdentifier)') {
                // $('#btnSave').hide();
                // $('#btnEdit').hide();
                // $('#btnDelete').hide();
                $('#schedule :input').prop('disabled', true); //или удалить их ваще??? зачем маячат выключенные перед глазами
                $('#btnClose').prop('disabled', false);
                $('#Completed').prop('disabled', false);
            }
            else {
                $('#schedule :input').prop('disabled', false);
                $('#btnClose').prop('disabled', false);
            };
            $('#schedule').modal('show');

            $('#btnEdit').show();
            $('#btnDelete').show();
            $('#btnSave').hide();
            $('#Title').focus();
            $('#Completed').show();
            $('#completed').show();
        }

        function ShowEventComments(id) {
            $.ajax({
                type: "GET",
                url: "/Comment/ShowEventCommentsPartial",
                data: { id: id },
                dataType: 'html',
                success: function (data) {
                    $('#show-event-comments-partial').html(data);
                    $('#EventId').val(id);
                }
            });
        }

        function CreateComment(id) {
            $.ajax({
                type: "GET",
                url: "/Comment/CreateCommentPartial",
                dataType: 'html',
                success: function (data) {
                    $('#create-comment-section-partial').html(data);
                    $('#EventId').val(id);
                }
            });
        }

        function GetEventDetails(id) {
            return $.ajax({
                dataType: 'json',
                type: "GET",
                url: "/Event/GetEvent",
                data: { id: id },
                async: false,
                success: function (res) {
                    if (typeof res === 'string' || res instanceof String) {
                        alert(res);
                    }
                },
                false: function (errormessage) {
                    alert(errormessage.responseText);
                }
            });
        }

        function Add(event) {
            event.preventDefault();
            var groupVal = $('#schedule').children('.modal-dialog').children('.modal-content').find('.Group').val();

            var eventdto =
            {
                userId: '@User.FindFirstValue(ClaimTypes.NameIdentifier)',
                groupIdentificator: groupVal,//$('.Group').val(),
                title: $('#Title').val(),
                description: $('#Description').val(),
                start: $('#Start').val(),
                end: $('#End').val(),
                allDay: $('#AllDay').is(':checked'),
                url: $('#Url').val(),
                backgroundColor: $('input[name="BackgroundColor"]:checked').val(),
            };

            if (groupVal === "null") {
                eventdto.groupIdentificator = null;
            };


            $.ajax({
                url: "/Event/CreateEvent",
                data: JSON.stringify(eventdto),
                type: "POST",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (result) {
                    $('#schedule').modal('hide');
                    alert(result);
                    someCalendar.refetchEvents();
                },
                error: function (errormessage) {
                    //var data = errormessage.responseJSON;
                    //var jsonData = JSON.parse(JSON.stringify(data));
                    //console.log(jsonData);
                    console.log(errormessage.responseJSON.Start[0]);
                    //for (n1 in data) {
                    //    console.log(n1);
                    //}
                    alert(errormessage.responseText);
                }
            });
        }

        function Update(event) {
            event.preventDefault();

            var groupVal = $('#schedule').children('.modal-dialog').children('.modal-content').find('.Group').val();

            var eventdto =
            {
                userId: $('#UserId').val(),
                id: $('#Id').val(),
                isDone: $('#Completed').is(':checked'),
                title: $('#Title').val(),
                description: $('#Description').val(),
                start: $('#Start').val(),
                end: $('#End').val(),
                allDay: $('#AllDay').is(':checked'),
                url: $('#Url').val(),
                backgroundColor: $('input[name="BackgroundColor"]:checked').val(),
                donedById: $('#DoneId').val() === "" ? null : $('#DoneId').val(),
                donedAt: $('#DoneTime').text() === "" ? null : moment($('#DoneTime').text()).format('YYYY-MM-DDTHH:mm'),
                donedBy: $('#DoneUser').text() === "" ? null : $('#DoneUser').text(),
                groupIdentificator: groupVal === "null" ? null : groupVal
            };

            $.ajax({
                url: "/Event/UpdateEvent",
                data: JSON.stringify(eventdto),
                type: "POST",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (result) {
                    alert(result);
                    someCalendar.refetchEvents();
                },
                error: function (errormessage) {
                    alert(errormessage.responseText);
                }
            });
        }

        function Delete(event) {
            event.preventDefault();

            const result = confirm('Are you sure to delete event "' + $('#Title').val() + '" ?');
            if (result) {
                var eventId = $('#Id').val();
                $.ajax({
                    url: "/Event/DeleteEvent",
                    data: JSON.stringify(eventId),
                    type: "POST",
                    contentType: "application/json;charset=utf-8",
                    dataType: "json",
                    success: function (result) {
                        $('#schedule').modal('hide');
                        alert(result);
                        someCalendar.refetchEvents();
                    },
                    error: function (errormessage) {
                        alert(errormessage.responseText);
                    }
                });
            } else {
                alert("Event is not deleted!");
            }
        }
    </script>
}
@* 
<h4 class="mb-3">Draggable Events</h4>
<div id="external-events-list" class="d-flex flex-wrap">
    <div class="fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event badge me-3 my-1">
        <div class="fc-event-main">Event 1</div>
    </div>
    <div class="fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event badge me-3 my-1">
        <div class="fc-event-main">Event 2</div>
    </div>
    <div class="fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event badge me-3 my-1">
        <div class="fc-event-main">Event 3</div>
    </div>
    <div class="fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event badge me-3 my-1">
        <div class="fc-event-main">Event 4</div>
    </div>
    <div class="fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event badge me-3 my-1">
        <div class="fc-event-main">Event 5</div>
    </div>
</div>
<div class="mt-2 my-5">
    <div class="form-check form-check-custom form-check-solid">
        <input class="form-check-input" type="checkbox" value="" id="drop-remove" />
        <label class="form-check-label" for="drop-remove">
            Remove event after drop
        </label>
    </div>
</div> *@

<div id='calendar'></div>

<div class="modal fade" id="schedule">
    <div class="modal-dialog">
        <div class="modal-content">
            <form>
                <div class="modal-header">
                    <h4 class="modal-title">
                        Your Schedule
                    </h4>
                    <div class="form-group">
                        <label for="Completed" id="completed"><b>Done</b></label>
                        <input type="checkbox" id="Completed">

                        <small class="c-badge">
                            <input type="hidden" class="form-control" id="DoneId">
                            <h6>
                                <span id="DoneUserBy"></span><span id="DoneUser"></span>
                                <span id="DoneTimeAt"></span><span id="DoneTime"></span>
                            </h6>
                        </small>
                    </div>
                </div>
                <div class="modal-body">
                    <input type="hidden" class="form-control" id="Id">
                    <input type="hidden" class="form-control" id="UserId">
                    <div class="form-group">
                        <label for="Title"><b>Title</b></label>
                        <input type="text" class="form-control" id="Title" placeholder="Feed the cat" required>
                    </div>
                    <div class="form-group">
                        <label for="Start"><i>Start</i></label>
                        <input type="datetime-local" class="form-control" id="Start" required>
                    </div>
                    <div class="form-group">
                        <label for="End">End</label>
                        <input type="datetime-local" class="form-control" id="End" required>
                    </div>
                    <div class="form-group">
                        <label for="Description">Description</label>
                        <input type="text" class="form-control" id="Description" placeholder="Food with salmon, not tomatoes"> @*maxlength*@
                    </div>
                    <div class="form-group">
                        <label for="AllDay">All day</label>
                        <input type="checkbox" id="AllDay"> <label>Yes</label>
                    </div>
                    <div class="form-group">
                        <label for="Url">Url</label>
                        <input type="URL" class="form-control" id="Url" placeholder="https://food-for-every-cat.com">
                    </div>
                    <div class="form-group">
                        <label for="BackgroundColor">Priority</label>
                        <input type="radio" id="BackgroundColor" name="BackgroundColor" value="#a895e2"> <label>High</label>
                        <input type="radio" id="BackgroundColor" name="BackgroundColor" value="#5fbe7d" required> <label>Normal</label>
                        <input type="radio" id="BackgroundColor" name="BackgroundColor" value="#69b1ff"> <label>Low</label>
                        <input type="radio" id="BackgroundColor" name="BackgroundColor" value="#505149" style="display:none" />
                    </div>

                    @*group select here*@
                    <script>
                        $(document).ready(function () {
                            $('.group-selector-partial').load('/Event/ShowUserGroupsDropDownPartial');
                        });
                    </script>
                    <div class="group-selector-partial"> </div>

                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger" id="btnDelete" formnovalidate="formnovalidate" onclick="return Delete(event);">Delete event</button>  @*//formnovalidate?*@
                    <button type="submit" class="btn btn-success" id="btnSave">Create</button>
                    <button type="submit" class="btn btn-success" id="btnEdit">Save</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal" id="btnClose">Close</button>
                </div>
            </form>

            @*comment section here*@
            <div id="show-event-comments-partial"> </div>
            <div id="create-comment-section-partial"> </div>
        </div>
    </div>
</div>