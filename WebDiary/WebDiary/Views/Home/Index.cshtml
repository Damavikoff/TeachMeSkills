@model WebDiary.Models.EventDTO

@{
    ViewData["Title"] = "Event Calendar";
}

@section scripts{
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                nowIndicator: true,
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title', // 'addEventButton',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                navLinks: true, // can click day/week names to navigate views
                editable: true,
                selectable: true,
                selectMirror: true,
                droppable: true,
                dayMaxEvents: true, // allow "more" link when too many events

                events: '/Home/LoadEvents', //ajax

                eventClick: function(info) {
                    info.jsEvent.preventDefault(); // don't let the browser navigate
                    var resp = GetDetails(info.event.id);
                    ShowEventPopupValues(resp.responseJSON);
                    if (info.event.url) {
                        window.open(info.event.url);
                    }
                },

                dateClick: function (date, allDay, jsEvent, view) {
                    var start_date = moment(date.dateStr).format('YYYY-MM-DDTHH:MM');
                    ShowEventPopup(start_date);
                },

                eventResize: function (info) {
                    alert(info.event.title + " end is now " + info.event.end.toISOString());

                    if (!confirm("is this okay?")) {
                        info.revert();
                    }
                },

                eventDidMount: function (info) {
                    $(info.el).tooltip({ //bootstrap tooltip
                        title: info.event.extendedProps.description,
                    });

                },
                eventWillUnmount: function (info) {
                    $(info.el).tooltip('dispose');
                }
            });
            calendar.render();
        });

        $('#btnClose').click(function () {
            $('#schedule').modal('hide');
        });

        $("#btnSave").click(function (e) {
            if ($("#Title")[0].checkValidity() && $("#Start")[0].checkValidity() && 
                $("#End")[0].checkValidity() && $("#Description")[0].checkValidity() &&
                $("#BackgroundColor")[0].checkValidity() && $("#Url")[0].checkValidity()) {
                e.preventDefault();Add();
            }
            else {
                return 0;
            }
        });
        $("#btnEdit").click(function () {
            if ($("#Title")[0].checkValidity() && $("#Start")[0].checkValidity() &&
                $("#End")[0].checkValidity() && $("#Description")[0].checkValidity() &&
                $("#BackgroundColor")[0].checkValidity() && $("#Url")[0].checkValidity()) {
                Update();
            }
            else {
                return 0;
            }
        });

        function ClearPopupFormValues() {
            //clear forms after closing
            $('#Title').val("");
            $('#Description').val("");
            $('#Start').val("");
            $('#End').val("");
            $('#Url').val("");
            $('#AllDay').prop('checked', false);
            $('input:radio[name=BackgroundColor]').each(function () { $(this).prop('checked', false); });
        }

        function ShowEventPopup(sendDate) {
            ClearPopupFormValues();
            $('#Start').val(sendDate);
            $('#End').val(sendDate);  //value="2020-03-13T18:22" seconds from number of month
            $('#schedule').modal('show');
            $('#btnEdit').hide();
            $('#btnSave').show();
            $('#Title').focus();
        }
        
        function ShowEventPopupValues(res) {
            ClearPopupFormValues();
            $('#Id').val(res.id);
            $('#Title').val(res.title);
            $('#Description').val(res.description);
            $('#Start').val(res.start);
            $('#End').val(res.end);
            $('#Url').val(res.url);
            $('#AllDay').prop('checked', res.allDay);
            $('input:radio[name=BackgroundColor]').each(function () {
                if($(this).val() == res.backgroundColor) {
                    $(this).prop('checked', true);
                } else {
                    $(this).prop('checked', false);
                }
            });
            $('#schedule').modal('show');
            $('#btnEdit').show();
            $('#btnSave').hide();
            $('#Title').focus();
        }

        function GetDetails(id) {
            return $.ajax({
                dataType: 'json',
                type: "GET",
                url: "/Home/GetEvent",
                data: { id: id },
                async: false,
                success: function (res) {
                },
            });
        }

        function Add() {
            var eventdto =
            {
                title: $('#Title').val(),
                description: $('#Description').val(),
                start: $('#Start').val(),
                end: $('#End').val(),
                allDay: $('#AllDay').is(':checked'),
                url: $('#Url').val(),
                backgroundColor: $('input[name="BackgroundColor"]:checked').val()
            };
            
            $.ajax({
                url: "/Home/CreateEvent",
                data: JSON.stringify(eventdto),
                type: "POST",
                //async: false, //запрос делается асинхронно и когда приходит ответ на запрос - сама функция уже закончила свое выполнение
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (result) {
                    $('#schedule').modal('hide');
                    alert(result);
                    $('#calendar').fullCalendar('refetchEvents');
                },
                error: function (errormessage) {
                    alert(errormessage.responseText);
                }
            });
        }

        function Delete() {
            var eventId = $('#Id').val();
            $.ajax({
                url: "/Home/DeleteEvent",
                data: JSON.stringify(eventId),
                type: "POST",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (result) {
                    $('#schedule').modal('hide');
                    alert(result);
                    $('#calendar').fullCalendar('refetchEvents');
                },
                error: function (errormessage) {
                    alert(errormessage.responseText);
                }
            });
        }

        function Update() {
            var eventdto =
            {
                id: $('#Id').val(),
                title: $('#Title').val(),
                description: $('#Description').val(),
                start: $('#Start').val(),
                end: $('#End').val(),
                allDay: $('#AllDay').is(':checked'),
                url: $('#Url').val(),
                backgroundColor: $('input[name="BackgroundColor"]:checked').val()
            };

            $.ajax({
                url: "/Home/UpdateEvent",
                data: JSON.stringify(eventdto),
                type: "POST",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (result) {
                    $('#schedule').modal('hide');
                    alert(result);
                    $('#calendar').fullCalendar('refetchEvents');
                },
                error: function (errormessage) {
                    alert(errormessage.responseText);
                }
            });
        }
    </script>
}

<div id='calendar'></div>

<div class="modal fade" id="schedule">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Your Schedule</h4>
            </div>
            <div class="modal-body">
                <form>
                    <input type="hidden" class="form-control" id="Id">
                    <div class="form-group">
                        <label for="Title">Title</label>
                        <input type="text" class="form-control" id="Title" required>
                    </div>
                    <div class="form-group">
                        <label for="Start">Start</label> 
                        <input type="datetime-local" class="form-control" id="Start" required>
                    </div>
                    <div class="form-group">
                        <label for="End">End</label>
                        <input type="datetime-local" class="form-control" id="End" required>
                    </div>
                    <div class="form-group">
                        <label for="Description">Description</label>
                        <input type="text" class="form-control" id="Description" required> @*maxlength*@
                    </div>
                    <div class="form-group">
                        <label for="AllDay">All day</label>
                        <input type="checkbox" id="AllDay"> <label>Yes</label>
                    </div>
                    <div class="form-group">
                        <label for="Url">Url</label>
                        <input type="URL" class="form-control" id="Url">
                    </div>
                    <div class="form-group">
                        <label for="BackgroundColor">Priority</label>
                        <input type="radio" id="BackgroundColor" name="BackgroundColor" value="#a895e2"> <label>High</label>
                        <input type="radio" id="BackgroundColor" name="BackgroundColor" value="#5fbe7d" required> <label>Normal</label>
                        <input type="radio" id="BackgroundColor" name="BackgroundColor" value="#69b1ff"> <label>Low</label>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-danger" id="btnDelete" formnovalidate="formnovalidate" onclick="return Delete();">Delete event</button>
                        <button type="submit" class="btn btn-success" id="btnSave">Create</button>
                        @*//form validation is the form been validated before submit. 
                        //So if you want to use HTML 5 default form validation with the submit button which has an onclick event, 
                        //the form validation will not work as it is skipped, because these validations are performed when the form is submitted, 
                        //in fact the button with onclick method just call a normal js function.*@
                        <button type="submit" class="btn btn-success" id="btnEdit">Save</button>
                        <button type="button" class="btn btn-danger" data-dismiss="modal" id="btnClose">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>